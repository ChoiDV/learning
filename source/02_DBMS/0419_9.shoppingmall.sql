-- [IV] 쇼핑몰 설계
DROP TABLE MEMBER;
CREATE TABLE MEMBER(
    mID VARCHAR2(20) PRIMARY KEY,
    mNAME VARCHAR2(50) NOT NULL,
    mADDRESS VARCHAR2(255) NOT NULL,
    mTEL VARCHAR2(30) NOT NULL,
    mEMAIL VARCHAR2(40) DEFAULT NULL );

DROP TABLE PRODUCT;
CREATE TABLE PRODUCT(
    pCODE VARCHAR2(5) PRIMARY KEY,
    pNAME VARCHAR2(50) NOT NULL,
    pPRICE NUMBER(6),
    pSTOCK NUMBER(3) DEFAULT 0);

DROP TABLE CART;
CREATE TABLE CART(
    cNO NUMBER(9) PRIMARY KEY,
    mID REFERENCES MEMBER(mID),
    pCODE REFERENCES PRODUCT(pCODE),
    QTY NUMBER(4),
    COST NUMBER(9));

DROP TABLE ORDERS;
CREATE TABLE ORDERS(
    oNO NUMBER(11) PRIMARY KEY,
    mID REFERENCES MEMBER(mID),
    oADDRESS VARCHAR2(255) NOT NULL,
    oTEL VARCHAR2(30) NOT NULL,
    oDATE DATE DEFAULT SYSDATE );

DROP TABLE ORDERS_DETAILS;
CREATE TABLE ORDERS_DETAILS(
    odNO NUMBER(9) PRIMARY KEY,
    oNO REFERENCES ORDERS(oNO),
    pCODE REFERENCES PRODUCT(pCODE),
    QTY NUMBER(3),
    COST NUMBER(9) );
    
DROP SEQUENCE CART_SEQ;
CREATE SEQUENCE CART_SEQ
    MAXVALUE 999999
    NOCACHE
    NOCYCLE;

DROP SEQUENCE ORDERS_SEQ;
CREATE SEQUENCE ORDERS_SEQ
    MAXVALUE 999999
    NOCACHE
    NOCYCLE;

DROP SEQUENCE ORDERS_DETAILS_SEQ;
CREATE SEQUENCE ORDERS_DETAILS_SEQ
    MAXVALUE 999999
    NOCACHE
    NOCYCLE ;

SELECT * FROM MEMBER;
INSERT INTO MEMBER 
    VALUES ('abc','홍길동','서울시 강남구','010-1111-1111','hong@naver.com');
INSERT INTO MEMBER
    VALUES ('def','전투왕','서울시 서대문구','010-2222-2222',NULL);

SELECT * FROM PRODUCT;
INSERT INTO PRODUCT
    VALUES ('A1','맥주',3000,100);
INSERT INTO PRODUCT
    VALUES ('A2','소주',2000,100);
INSERT INTO PRODUCT
    VALUES ('B1','땅콩',3500,100);
INSERT INTO PRODUCT
    VALUES ('B2','오징어',5000,100);
INSERT INTO PRODUCT
    VALUES ('C1','기저귀',7000,100);

SELECT * FROM ORDERS;
INSERT INTO ORDERS
    VALUES(TO_CHAR(SYSDATE,'RRMMDD')||TRIM(TO_CHAR(ORDERS_SEQ.NEXTVAL,'00000')),'abc','서울 강남구','010-1111-1111',SYSDATE);
INSERT INTO ORDERS
    VALUES(TO_CHAR(SYSDATE,'RRMMDD')||TRIM(TO_CHAR(ORDERS_SEQ.NEXTVAL,'00000')),'def','서울 서대문구','010-2222-2222',SYSDATE);
INSERT INTO ORDERS
    VALUES(TO_CHAR(SYSDATE,'RRMMDD')||TRIM(TO_CHAR(ORDERS_SEQ.NEXTVAL,'00000')),'abc','경기도 과천','010-3333-3333',SYSDATE);

SELECT * FROM ORDERS_DETAILS;
INSERT INTO ORDERS_DETAILS
    VALUES (ORDERS_DETAILS_SEQ.NEXTVAL,'22041900001','A1',3,(SELECT pPRICE FROM PRODUCT WHERE pCODE='A1')*3);
UPDATE PRODUCT SET pSTOCK=pSTOCK-3 WHERE pCODE='A1';

INSERT INTO ORDERS_DETAILS
    VALUES (ORDERS_DETAILS_SEQ.NEXTVAL,'22041900001','B1',1,(SELECT pPRICE FROM PRODUCT WHERE pCODE='B1')*1);
UPDATE PRODUCT SET pSTOCK=pSTOCK-1 WHERE pCODE='B1';   

INSERT INTO ORDERS_DETAILS
    VALUES (ORDERS_DETAILS_SEQ.NEXTVAL,'22041900001','A2',2,(SELECT pPRICE FROM PRODUCT WHERE pCODE='A2')*2);
UPDATE PRODUCT SET pSTOCK=pSTOCK-2 WHERE pCODE='A2'; 

INSERT INTO ORDERS_DETAILS
    VALUES (ORDERS_DETAILS_SEQ.NEXTVAL,'22041900001','B2',1,(SELECT pPRICE FROM PRODUCT WHERE pCODE='B2')*1);
UPDATE PRODUCT SET pSTOCK=pSTOCK-1 WHERE pCODE='B2'; 


INSERT INTO ORDERS_DETAILS
    VALUES (ORDERS_DETAILS_SEQ.NEXTVAL,'22041900002','A2',2,(SELECT pPRICE FROM PRODUCT WHERE pCODE='A2')*2);
UPDATE PRODUCT SET pSTOCK=pSTOCK-2 WHERE pCODE='A2';
INSERT INTO ORDERS_DETAILS
    VALUES (ORDERS_DETAILS_SEQ.NEXTVAL,'22041900002','B2',2,(SELECT pPRICE FROM PRODUCT WHERE pCODE='B2')*1);
UPDATE PRODUCT SET pSTOCK=pSTOCK-2 WHERE pCODE='B2';
    
INSERT INTO ORDERS_DETAILS
    VALUES (ORDERS_DETAILS_SEQ.NEXTVAL,'22041900002','C1',1,(SELECT pPRICE FROM PRODUCT WHERE pCODE='C1')*1);  
UPDATE PRODUCT SET pSTOCK=pSTOCK-1 WHERE pCODE='C1';


INSERT INTO ORDERS_DETAILS
    VALUES (ORDERS_DETAILS_SEQ.NEXTVAL,'22041900003','A1',3,(SELECT pPRICE FROM PRODUCT WHERE pCODE='A1')*3);
UPDATE PRODUCT SET pSTOCK=pSTOCK-3 WHERE pCODE='A1';  

INSERT INTO ORDERS_DETAILS
    VALUES (ORDERS_DETAILS_SEQ.NEXTVAL,'22041900003','B1',1,(SELECT pPRICE FROM PRODUCT WHERE pCODE='B1')*1);
UPDATE PRODUCT SET pSTOCK=pSTOCK-1 WHERE pCODE='B1';  

INSERT INTO ORDERS_DETAILS
    VALUES (ORDERS_DETAILS_SEQ.NEXTVAL,'22041900003','C1',1,(SELECT pPRICE FROM PRODUCT WHERE pCODE='C1')*1); 
UPDATE PRODUCT SET pSTOCK=pSTOCK-1 WHERE pCODE='C1';

SELECT * FROM MEMBER;
SELECT * FROM PRODUCT;
SELECT * FROM ORDERS;
SELECT * FROM ORDERS_DETAILS;

-- 홍길동의 처음주문내역
SELECT mNAME, O.oADDRESS, O.oTEL, O.oDATE, OD.* 
    FROM MEMBER M,  ORDERS O ,ORDERS_DETAILS OD
        WHERE M.mID=o.mID
            AND M.mID='abc'  
                AND O.oNo = OD.oNO
                    AND O.oNO = 22041900001;
-- 홍길동의 두번째 주문내역
SELECT mNAME, O.oADDRESS, O.oTEL, O.oDATE, OD.* 
    FROM MEMBER M,  ORDERS O ,ORDERS_DETAILS OD
        WHERE M.mID=o.mID
            AND M.mID='abc'             
                AND O.oNo = OD.oNO
                    AND O.oNO = 22041900003;
-- 홍길동의 전체 주문내역
SELECT mNAME, O.oADDRESS, O.oTEL, O.oDATE, OD.* 
    FROM MEMBER M,  ORDERS O ,ORDERS_DETAILS OD
        WHERE M.mID=o.mID
            AND M.mID='abc'             
                AND O.oNo = OD.oNO;
                    
                
--  전투왕의 주문내역
SELECT mNAME, O.oADDRESS, O.oTEL, O.oDATE, OD.* 
    FROM MEMBER M,  ORDERS O ,ORDERS_DETAILS OD
        WHERE M.mID=o.mID
            AND M.mID='def'
              AND  mNAME='전투왕'
                AND O.oNo = OD.oNO;